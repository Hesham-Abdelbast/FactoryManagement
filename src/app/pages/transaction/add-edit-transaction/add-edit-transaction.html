<app-h-modal (closeEvent)="close()" [headerTitle]="isEditMode ? 'تعديل معاملة' : 'إضافة معاملة'">

  <form [formGroup]="transactionForm" (ngSubmit)="onSubmit()" class="container mt-3" dir="rtl">

    <div class="card shadow-lg p-4">

      <div class="row g-3">

        <!-- نوع المعاملة -->
        <div class="col-md-6 text-end">
          <label class="form-label fw-bold">نوع المعاملة <span class="text-danger">*</span></label>
          <select formControlName="type" class="form-select text-end" [ngClass]="{'is-invalid': invalid('type')}">
            <option value="">-- اختر --</option>
            <option value="Income">وارد</option>
            <option value="Outcome">صادر</option>
          </select>
          <div class="invalid-feedback text-end">نوع المعاملة مطلوب.</div>
        </div>

        <!-- نوع المادة -->
        <div class="col-md-6 text-end">
          <label class="form-label fw-bold">نوع المادة <span class="text-danger">*</span></label>
          <select formControlName="materialTypeId" class="form-select text-end"
            [ngClass]="{'is-invalid': invalid('materialTypeId')}">
            <option value="">-- اختر --</option>
            @for (item of data.materialTypeLst; track $index) {
            <option [value]="item.id">{{ item.name }}</option>
            }
          </select>
          <div class="invalid-feedback text-end">نوع المادة مطلوب.</div>
        </div>

        <!-- التاجر -->
         <div class="col-md-6 text-end">
        <label class="form-label fw-bold">التاجر <span class="text-danger">*</span></label>
        <app-h-auto-complete
          [data]="merchantKeyValue"
          placeholder="اختر التاجر"
          (valueSelected)="onSelected($event)">
        </app-h-auto-complete>
      </div>
        <!-- <div class="col-md-6 text-end">
          <label class="form-label fw-bold">التاجر <span class="text-danger">*</span></label>
          <select formControlName="merchantId" class="form-select text-end"
            [ngClass]="{'is-invalid': invalid('merchantId')}">
            <option value="">-- اختر --</option>
            @for (item of data.merchantLst; track $index) {
            <option [value]="item.id">{{ item.name }}</option>
            }
          </select>
          <div class="invalid-feedback text-end">التاجر مطلوب.</div>
        </div> -->

        <!-- المخزن -->
        <div class="col-md-6 text-end">
          <label class="form-label fw-bold">المخزن <span class="text-danger">*</span></label>
          <select formControlName="warehouseId" class="form-select text-end"
            [ngClass]="{'is-invalid': invalid('warehouseId')}">
            <option value="">-- اختر --</option>
            @for (item of data.warehouseLst; track $index) {
            <option [value]="item.id">{{ item.name }}</option>
            }
          </select>
          <div class="invalid-feedback text-end">المخزن مطلوب.</div>
        </div>

        <!-- تاريخ المعامله -->
        <div class="col-md-6 text-end">
          <label class="form-label fw-bold">تاريخ المعامله <span class="text-danger">*</span></label>
          <input type="date" formControlName="createDate" class="form-control text-end"
            [ngClass]="{'is-invalid': invalid('createDate')}">
          <div class="invalid-feedback text-end">التاريخ مطلوب.</div>
        </div>

        <!-- إظهار رقم الهاتف -->
        <div class="col-md-6 text-end">
          <label class="form-label fw-bold">إظهار رقم الهاتف</label>
          <select formControlName="showPhoneNumber" class="form-select text-end" [ngClass]="{'is-invalid': invalid('showPhoneNumber')}">
            <option value="">-- اختر --</option>
            <option value="true">نعم</option>
            <option value="false">لا</option>
          </select>
        </div>
      </div>
      <hr>

      <h5 class="fw-bold mt-2 text-end">بيانات الشاحنة</h5>

      <div class="row g-3">

        <!-- اسم السائق -->
        <div class="col-md-6 text-end">
          <label class="form-label">اسم السائق</label>
          <input type="text" formControlName="carDriverName" class="form-control text-end"
            placeholder="اسم السائق إن وجد">
        </div>

        <!-- وزن السيارة بالحمولة -->
        <div class="col-md-6 text-end">
          <label class="form-label fw-bold">الوزن الكلى (كجم) <span class="text-danger">*</span></label>
          <input type="number" formControlName="carAndMatrerialWeight" class="form-control text-end"
            [ngClass]="{'is-invalid': invalid('carAndMatrerialWeight')}" (input)="recalculateQuantity()">
          <div class="invalid-feedback text-end">الوزن يجب أن يكون أكبر من الصفر.</div>
        </div>

        <!-- وزن السيارة فارغة -->
        <div class="col-md-6 text-end">
          <label class="form-label fw-bold">الوزن الفارغ (كجم) <span class="text-danger">*</span></label>
          <input type="number" formControlName="carWeight" class="form-control text-end"
            [ngClass]="{'is-invalid': invalid('carWeight')}" (input)="recalculateQuantity()">
          <div class="invalid-feedback text-end">الوزن يجب أن يكون أكبر من الصفر.</div>
        </div>

        <!-- نسبة الشوائب -->
        <div class="col-md-6 text-end">
          <label class="form-label">نسبة الشوائب (%)</label>
          <input type="number" formControlName="percentageOfImpurities" class="form-control text-end"
            (input)="recalculateImpurities()">
        </div>

        <!-- وزن الشوائب -->
        <div class="col-md-6 text-end">
          <label class="form-label">وزن الشوائب (كجم)</label>
          <input type="number" formControlName="weightOfImpurities" class="form-control text-end" readonly>
        </div>

        <!-- الكمية الناتجة -->
        <div class="col-md-6 text-end">
          <label class="form-label fw-bold">الوزن الصافي</label>
          <input type="number" formControlName="quantity" class="form-control text-end" readonly>
        </div>

      </div>

      <hr>

      <h5 class="fw-bold mt-3 text-end">المالية</h5>

      <div class="row g-3">

        <!-- سعر الوحدة -->
        <div class="col-md-6 text-end">
          <label class="form-label fw-bold">السعر للوحدة <span class="text-danger">*</span></label>
          <input type="number" formControlName="pricePerUnit" class="form-control text-end"
            [ngClass]="{'is-invalid': invalid('pricePerUnit')}" (input)="updateTotalAmount()">
          <div class="invalid-feedback text-end">السعر غير صالح.</div>
        </div>

        <!-- الإجمالي -->
        <div class="col-md-6 text-end">
          <label class="form-label fw-bold">الإجمالي</label>
          <input type="number" class="form-control text-end" formControlName="totalAmount"
            (input)="UpdatePricePerUnit()">
        </div>

        <!-- المبلغ المدفوع -->
        <div class="col-md-6 text-end">
          <label class="form-label">المبلغ المدفوع</label>
          <input type="number" formControlName="amountPaid" class="form-control text-end" (input)="updateRemaining()">
        </div>

        <!-- المتبقي -->
        <div class="col-md-6 text-end">
          <label class="form-label">المتبقي</label>
          <input type="number" class="form-control text-end" [value]="remaining" readonly>
        </div>

      </div>

      <!-- ملاحظات -->
      <div class="mt-3 text-end">
        <label class="form-label">ملاحظات</label>
        <textarea formControlName="notes" class="form-control text-end" rows="3"
          placeholder="أدخل أي ملاحظات إضافية"></textarea>
      </div>

      <!-- أزرار -->
      <div class="d-flex justify-content-end mt-4">
        <button class="btn btn-primary ms-2" type="submit" [disabled]="transactionForm.invalid">
          {{ isEditMode ? 'تحديث' : 'حفظ' }}
        </button>
        <button class="btn btn-secondary" type="button" (click)="close()">إلغاء</button>
      </div>

    </div>

  </form>

</app-h-modal>