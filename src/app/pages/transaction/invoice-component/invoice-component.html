<ng-container *ngIf="!isLoading; else loadingTpl">
  <div class="p-2 overflow-auto" dir="rtl" *ngIf="invoiceDto as inv; else noDataTpl">
    <header>
      <div class="logo">{{ inv.companyName }}</div>
      <div class="invoice-title">
        <h1>فاتورة</h1>
      </div>
    </header>

    <div class="invoice-details">
      <div>
        <h3 class="section-title">تفاصيل المعاملة</h3>
        <div class="detail-row">
          <div class="detail-label">معرف المعاملة:</div>
          <div>{{ inv.transactionIdentifier }}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">النوع:</div>
          <div>
            <span [class]="'transaction-type ' + getTransactionTypeClass()">
              {{ getTransactionTypeText() }}
            </span>
          </div>
        </div>
        <div class="detail-row">
          <div class="detail-label">التاريخ:</div>
          <div>{{ formatDate(inv.createDate) }}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">نوع المادة:</div>
          <div>{{ inv.materialTypeName || '-' }}</div>
        </div>
      </div>

      <div>
        <h3 class="section-title">الأطراف</h3>
        <div class="detail-row">
          <div class="detail-label">التاجر:</div>
          <div>{{ inv.merchantName || '-' }}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">المخزن:</div>
          <div>{{ inv.warehouseName || '-' }}</div>
        </div>
        @if(inv.showPhoneNumber) {
          <div class="detail-row">
          <div class="detail-label">الاتصال:</div>
          <div>{{ inv.companyPhone || '-' }}</div>
        </div>
        }
        <div class="detail-row">
          <div class="detail-label">العنوان:</div>
          <div>{{ inv.companyAddress || '-' }}</div>
        </div>
      </div>
    </div>

    <!-- Truck Details Section -->
    <div class="truck-section">
  <h3 class="section-title">تفاصيل الشاحنة</h3>

  <!-- First Row: 3 items -->
  <div class="truck-details-row">
    <div class="detail-item">
      <div class="detail-label">اسم السائق:</div>
      <div class="detail-value">{{ inv.carDriverName || '-' }}</div>
    </div>

    <div class="detail-item">
      <div class="detail-label">الوزن الكلى:</div>
      <div class="detail-value">{{ inv.carAndMatrerialWeight | number }}</div>
    </div>

    <div class="detail-item">
      <div class="detail-label">الوزن الفارغ:</div>
      <div class="detail-value">{{ inv.carWeight | number }}</div>
    </div>
  </div>

  <!-- Second Row: 2 items -->
  <div class="truck-details-row">
    <div class="detail-item">
      <div class="detail-label">نسبة الشوائب:</div>
      <div class="detail-value">{{ formatPercentage(inv.percentageOfImpurities) }}</div>
    </div>

    <div class="detail-item">
      <div class="detail-label">وزن الشوائب:</div>
      <div class="detail-value">{{ impuritiesWeight | number }}</div>
    </div>
  </div>

  <!-- Third Row: 1 item -->
  <div class="truck-details-row">
    <div class="detail-item full-width">
      <div class="detail-label">الوزن الصافي:</div>
      <div class="detail-value">{{ netAfterImpurities | number }}</div>
    </div>
  </div>
</div>





    <div style="padding: 0 30px;">
      <h3 class="section-title">بنود المعاملة</h3>
      <table class="items-table">
        <thead>
          <tr>
            <th>الوصف</th>
            <th>الكمية</th>
            <th>سعر الوحدة</th>
            <th class="text-center">المبلغ</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{{ inv.materialTypeName || '-' }}</td>
            <td>{{ inv.quantity| number }}</td>
            <td>{{ inv.pricePerUnit | number}}</td>
            <td class="text-center">{{ totalAmount| number }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="total-section">
      <div>
        <h3 class="section-title">ملاحظات</h3>
        <div class="notes">
          {{ inv.notes || 'لا توجد ملاحظات' }}
        </div>
      </div>

      <div>
        <h3 class="section-title">ملخص المبالغ</h3>
        <div class="amounts">
          <div class="amount-row لاخق">
            <div>المجموع الفرعي:</div>
            <div>{{ totalAmount | number}} دل</div>
          </div>
          <div class="amount-row">
            <div>المبلغ المدفوع:</div>
            <div>{{inv.amountPaid| number}} دل</div>
          </div>
          <div class="amount-row total-row">
            <div>الرصيد المستحق:</div>
            <div>{{balanceDue| number}} دل</div>
          </div>
        </div>
      </div>
    </div>

    <div class="action-buttons">
      <button class="btn btn-primary" (click)="printInvoice()">طباعة الفاتورة</button>
      <button class="btn btn-primary" (click)="close()">الرجوع</button>
    </div>

    <div class="footer">
      <p>شكرًا لتعاملك معنا!</p>
      <p>{{ inv.companyName }} • {{ inv.companyAddress }} • {{ inv.companyPhone }}</p>
    </div>
  </div>
</ng-container>

<ng-template #loadingTpl>
  <div class="loading">
    <div class="spinner"></div>
    <div>جارٍ تحميل بيانات الفاتورة...</div>
  </div>
</ng-template>

<ng-template #noDataTpl>
  <div class="loading">
    لا توجد بيانات لعرضها
  </div>
</ng-template>